"use strict";var app=angular.module("ToyotaPOCApp",["ngRoute","edittrip","settings","phonegap","viewtrips","logtrip","locator","update-details","SQLservices"]).run(["DB",function(e){e.openDb(),e.createTables(),e.setupRecords()}]);app.config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/home.html"}).when("/viewtrips",{templateUrl:"views/viewtrips.html",controller:"ViewTripsController"}).when("/logtrip",{templateUrl:"views/logtrip.html"}).when("/logtrip/gpstracker",{templateUrl:"views/logtrip.gpstracker.html",controller:"GPSTrackerController"}).when("/logtrip/manual",{templateUrl:"views/logtrip.manual.html",controller:"LogManualController"}).when("/update/edittrip/:id",{templateUrl:"views/edittrip.html",controller:"EditTripController"}).when("/updatedetails",{templateUrl:"views/update-details.html"}).when("/update/driver",{templateUrl:"views/driver.html",controller:"DriverController"}).when("/update/editdriver/:id",{templateUrl:"views/editdriver.html",controller:"EditDriverController"}).when("/update/vehicle",{templateUrl:"views/vehicle.html",controller:"VehicleController"}).when("/update/editvehicle/:id",{templateUrl:"views/editvehicle.html",controller:"EditVehicleController"}).when("/locator",{templateUrl:"views/locator.html",controller:"LocatorController"}).when("/lookup",{templateUrl:"views/lookup.html",controller:"LookupController"})}]),app.run(["$rootScope","AppSettings","NetworkService","NotificationService",function(e,t,o,r){o.startMonitoring(),e.$on(t.OnNetworkStatusChange,function(t,o){e.NetworkReady=o,o||r.alert("Lost Network!","Network","Ok")})}]),angular.module("SQLservices",[]).factory("DB",["$q","$rootScope",function(e){var t={};return t.db=null,t.openDb=function(){t.db=void 0!==window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:"ToyotaPOCDb"}):window.openDatabase("ToyotaPOCDb","1.0","database",-1)},t.createTables=function(){t.db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS Vehicles (id integer primary key, vehiclerego text, created datetime)"),e.executeSql("CREATE TABLE IF NOT EXISTS Drivers (id integer primary key, firstname text, lastname text, address text, created datetime)"),e.executeSql("CREATE TABLE IF NOT EXISTS NatureOfTrip (id integer primary key, purpose text, created datetime)"),e.executeSql("CREATE TABLE IF NOT EXISTS Trips (id integer primary key, kmfrom integer, kmto integer, vehicleid integer, natureoftripid integer, driverid integer, datestart datetime, dateend datetime, locationfrom text, locationto text, created datetime, FOREIGN KEY(vehicleid) REFERENCES Vehicles(id), FOREIGN KEY(natureoftripid) REFERENCES NatureOfTrip(id), FOREIGN KEY(driverid) REFERENCES Drivers(id))"),e.executeSql("CREATE TABLE IF NOT EXISTS ToyotaStation (id integer primary key, datetime datetime, address text, latitude text, long text)")})},t.setupRecords=function(){t.db.transaction(function(e){e.executeSql("SELECT * FROM NatureOfTrip",[],function(e,o){o.rows.length<=0&&(e.executeSql("INSERT INTO NatureOfTrip (purpose, created) VALUES (?,?)",["Private Usage","2014-12-20"],function(){t.onSuccess,t.onError}),e.executeSql("INSERT INTO NatureOfTrip (purpose, created) VALUES (?,?)",["Business usage","2014-12-20"],function(){t.onSuccess,t.onError}))},t.onError),e.executeSql("SELECT * FROM Drivers",[],function(e,o){o.rows.length<=0&&(e.executeSql("INSERT INTO Drivers (firstname, lastname, address, created) VALUES (?,?,?,?)",["Yann","Randri","Oakton CLarence Street","2014-12-20"],function(){t.onSuccess,t.onError}),e.executeSql("INSERT INTO Drivers (firstname, lastname, address, created) VALUES (?,?,?,?)",["Jason","Woods","Oakton CLarence Street","2014-12-20"],function(){t.onSuccess,t.onError}),e.executeSql("INSERT INTO Drivers (firstname, lastname, address, created) VALUES (?,?,?,?)",["Sergei","Mishkarudny","Oakton CLarence Street","2014-12-20"],function(){t.onSuccess,t.onError}),e.executeSql("INSERT INTO Drivers (firstname, lastname, address, created) VALUES (?,?,?,?)",["Aiden","Zadeh","Oakton CLarence Street","2014-12-20"],function(){t.onSuccess,t.onError}))},t.onError),e.executeSql("SELECT * FROM Vehicles",[],function(e,o){o.rows.length<=0&&(e.executeSql("INSERT INTO Vehicles (vehiclerego, created) VALUES (?,?)",["AL33LL","2014-12-20"],function(){t.onSuccess,t.onError}),e.executeSql("INSERT INTO Vehicles (vehiclerego, created) VALUES (?,?)",["BD89GG","2014-12-20"],function(){t.onSuccess,t.onError}))},t.onError),e.executeSql("SELECT * FROM ToyotaStation",[],function(e,o){o.rows.length<=0&&e.executeSql("INSERT INTO ToyotaStation  (datetime, long, latitude, address) VALUES (?,?,?,?)",["2014-12-20","151.052831","-33.858740","Lidcombe NSW Australia"],function(){t.onSuccess,t.onError})},t.onError)})},t.fetchAll=function(e){var t=[];if(e.rows.length>0)for(var o=0;o<e.rows.length;o++)t.push(e.rows.item(o));return t},t.fetch=function(e){return e.rows.item(0)},t.onSuccess=function(){alert("sql ok"),console.log("SQLite query was successful!")},t.onError=function(e,t){alert("sql"),console.log("SQLite Error: "+t.message)},t.query=function(o,r){r="undefined"!=typeof r?r:[];var n=e.defer();return t.db.transaction(function(e){e.executeSql(o,r,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})}),n.promise},t}]).factory("NatureOfTrip",["DB",function(e){var t=this;return t.all=function(){return e.query("SELECT * FROM NatureOfTrip").then(function(t){return e.fetchAll(t)})},t.getById=function(t){return e.query("SELECT * FROM NatureOfTrip WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t}]).factory("Vehicles",["DB",function(e){var t=this;return t.all=function(){return e.query("SELECT * FROM Vehicles").then(function(t){return e.fetchAll(t)})},t.getById=function(t){return e.query("SELECT * FROM vehicles WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t.remove=function(t){return e.query("DELETE FROM vehicles WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t.add=function(t){return e.query("INSERT INTO Vehicles (vehiclerego, created) VALUES (?,?)",[t,(new Date).getTime()]).then(function(t){return e.fetch(t)})},t.update=function(t,o){return e.query("UPDATE Vehicles SET vehiclerego=? WHERE id=?",[o,t])},t}]).factory("Drivers",["DB",function(e){var t=this;return t.all=function(){return e.query("SELECT * FROM Drivers").then(function(t){return e.fetchAll(t)})},t.getById=function(t){return e.query("SELECT * FROM Drivers WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t.remove=function(t){return e.query("DELETE FROM Drivers WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t.add=function(t,o,r){return e.query("INSERT INTO Drivers (firstname, lastname, address, created) VALUES (?,?,?,?)",[t,o,r,(new Date).getTime()]).then(function(t){return e.fetch(t)})},t.update=function(t,o,r,n){return e.query("UPDATE Drivers SET firstname=?, lastname=?, address=? WHERE id=?",[o,r,n,t])},t}]).factory("Trips",["DB",function(e){var t=this;return t.all=function(){return e.query("SELECT * FROM Trips").then(function(t){return e.fetchAll(t)})},t.getById=function(t){return e.query("SELECT * FROM Trips WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t.remove=function(t){return e.query("DELETE FROM Trips WHERE id = ?",[t]).then(function(t){return e.fetch(t)})},t.add=function(t,o,r,n,i,a,l,c,u){return e.query("INSERT INTO Trips (kmfrom, kmto, vehicleid, natureoftripid, driverid, datestart, dateend, locationfrom, locationto, created) VALUES (?,?,?,?,?,?,?,?,?,?)",[t,o,r,n,i,a,l,c,u,(new Date).getTime()]).then(function(t){return e.fetch(t)})},t.update=function(t,o,r,n,i,a,l,c,u,s){return e.query("UPDATE Trips SET kmfrom=?, kmto=?, vehicleid=?, natureoftripid=?, driverid=?, datestart=?, dateend=?, locationfrom=?, locationto=? WHERE id=?",[o,r,n,i,a,l,c,u,s,t])},t}]),angular.module("settings",[]).constant("AppSettings",{network_watch_interval:1e3,gps_error_threshold:5,map_zoom:12,OnNetworkStatusChange:"event::OnNetworkStatusChange"});var locatorControllers=angular.module("locator.controllers",[]);locatorControllers.controller("LocatorController",["$scope",function(e){function t(){var e=window.localStorage,t=JSON.parse(e.getItem("positions"));return null==t&&(t=[]),t}function o(e){var t=e.coords;n(t.longitude,t.latitude,a)}function r(e){alert(e.code+" "+e.message)}function n(e,t,o){var r=new google.maps.DirectionsService,n=new google.maps.DirectionsRenderer,a=document.getElementById("mapCanvasLookup"),l=new google.maps.LatLng(t,e),c=i(o),u={zoom:15,center:l,mapTypeId:google.maps.MapTypeId.ROADMAP},s=new google.maps.Map(a,u);n.setMap(s);var d={origin:l,destination:c,travelMode:google.maps.TravelMode.DRIVING};r.route(d,function(e,t){t==google.maps.DirectionsStatus.OK&&n.setDirections(e)})}function i(e){for(var o=t(),r=0;r<o.length;r++)if(e==o[r].address)return new google.maps.LatLng(o[r].latitude,o[r].long)}var a;document.addEventListener("deviceready",function(){var t=navigator.connection.type;e.networkStatus=t==Connection.NONE?"No Internet Access":"Connected to "+t+" network"}),e.loadFavs=function(){var o=t();null==o&&(o=[]),e.serviceList=o},document.addEventListener("pageinit",function(){e.loadFavs()}),e.init=function(){e.loadFavs()},e.init(),e.getRoute=function(e){a=e,navigator.geolocation.watchPosition(o,r,{timeout:6e4,maximumAge:5e4})},e.removeServiceStation=function(o){for(var r=t(),n=0;n<r.length;n++)r[n].address==o&&r.splice(n,1);var i=window.localStorage;i.setItem("positions",JSON.stringify(r)),e.loadFavs()}}]),locatorControllers.controller("LookupController",["$scope",function(e){function t(e){alert(e.code+" "+e.message)}function o(e){var t=e.coords;r(t),n(t)}function r(t){var o=t.latitude,r=t.longitude,n=new google.maps.LatLng(o,r),i=new google.maps.Geocoder;i.geocode({latLng:n},function(t,n){n==google.maps.GeocoderStatus.OK&&(e.latitude=o,e.longitude=r,e.address=t[1].formatted_address)})}function n(e){{var t=e.latitude,o=e.longitude,r=document.getElementById("lookupCanvas"),n=new google.maps.LatLng(t,o),i={zoom:15,center:n,mapTypeId:google.maps.MapTypeId.ROADMAP},a=new google.maps.Map(r,i);new google.maps.Marker({position:n,map:a,title:"Current position"})}}function i(){var e=window.localStorage,t=JSON.parse(e.getItem("positions"));return null==t&&(t=[]),t}function a(e,t,o,r){var n=6371,i=(o-e)*(Math.PI/180),a=(r-t)*(Math.PI/180),e=e*(Math.PI/180),o=o*(Math.PI/180),l=Math.sin(i/2)*Math.sin(i/2)+Math.sin(a/2)*Math.sin(a/2)*Math.cos(e)*Math.cos(o),c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),u=n*c;return u.toFixed(2)}function l(e,t,o,r){this.latitude=e,this.address=o,this.long=t,this.datetime=r}var c=50;e.getCurrentPosition=function(){navigator.geolocation.getCurrentPosition(o,t,{timeout:6e4,maximumAge:6e4,enableHighAccuracy:!0})},e.saveCurrentPosition=function(){var t=e.latitude,o=e.longitude,r=e.address,n=i();if(null==n&&(n=[]),e.favExists(r,n))alert("Address "+r+" has been saved previously");else{n.unshift(new l(t,o,r,new Date)),n.length>=c&&n.slice();var a=window.localStorage;a.setItem("positions",JSON.stringify(n)),alert("saved"+JSON.stringify(n))}},e.favExists=function(e,t){for(var o=0;o<t.length;o++)if(t[o].address==e)return!0;return!1},e.searchStations=function(t){navigator.geolocation.getCurrentPosition(function(o){var n=o.coords,i=n.latitude,a=n.longitude;r(n);for(var l=document.getElementById("lookupCanvas"),c=new google.maps.LatLng(i,a),u={zoom:15,center:c,mapTypeId:google.maps.MapTypeId.ROADMAP},s=new google.maps.LatLngBounds,d=new google.maps.Map(l,u),g=e.getToyotaStationsWithinRadius(t,i,a),p=0;p<g.length;p++){{new google.maps.Marker({position:g[p],map:d,title:"Current position"})}s.extend(g[p])}d.fitBounds(s)},function(){alert("failed to read current position")},{timeout:6e4,maximumAge:6e4,enableHighAccuracy:!0})},e.getToyotaStationsWithinRadius=function(e,t,o){for(var r=i(),n=[],l=0;l<r.length;l++){var c=r[l].latitude,u=r[l].long,s=a(t,o,c,u);e>=s&&n.push(new google.maps.LatLng(c,u))}return n}}]),angular.module("locator",["locator.controllers"]),angular.module("logtrip",["logtrip.manual","logtrip.gpstracker"]),angular.module("update-details",["driver","vehicle"]);var viewtripsControllers=angular.module("viewtrips.controllers",["SQLservices"]);viewtripsControllers.controller("ViewTripsController",["$q","$scope","Trips",function(e,t,o){t.loadData=function(){o.all().then(function(e){t.entries=e})},t.removeTrip=function(e){o.remove(e),t.loadData()},t.loadData()}]),angular.module("viewtrips",["viewtrips.controllers"]),angular.module("phonegap.geolocation",[]).factory("GeolocationService",["$rootScope","$log",function(e,t){var o=this;return o.watchId=null,o.trackingData=[],o.checkGeolocationAvailability=function(){return t.debug("cordovaGeolocationService.checkGeolocationAvailability."),navigator.geolocation?!0:(t.warn("Geolocation API is not available."),!1)},o.positionMoved=function(e){if(0==o.trackingData.length)return!0;var t=o.trackingData[o.trackingData.length-1];return!(e.coords.latitude==t.coords.latitude&&e.coords.longitude==t.coords.longitude)},{getCurrentPosition:function(r,n,i){t.debug("cordovaGeolocationService.getCurrentPosition.");var i=angular.extend({},{enableHighAccuracy:!0,timeout:1e4,maximumAge:1/0},i);o.checkGeolocationAvailability()&&navigator.geolocation.getCurrentPosition(function(t){r&&"function"==typeof r&&e.$apply(r(t))},function(t){n&&"function"==typeof n&&e.$apply(n(t))},i)},watchPosition:function(r,n,i){t.debug("cordovaGeolocationService.watchPosition."),o.trackingData=[];var i=angular.extend({},{enableHighAccuracy:!0,frequency:3e3},i);o.checkGeolocationAvailability()&&(o.watchId=navigator.geolocation.watchPosition(function(t){r&&"function"==typeof r&&o.positionMoved(t)&&(o.trackingData.push(t),e.$apply(r(t)))},function(t){n&&"function"==typeof n&&e.$apply(n(t))},i))},clearWatch:function(){return t.debug("cordovaGeolocationService.clearWatch."),o.checkGeolocationAvailability()&&o.watchId?(navigator.geolocation.clearWatch(o.watchID),o.watchID=null,o.trackingData):void 0}}}]),angular.module("phonegap",["phonegap.geolocation","phonegap.notification","phonegap.network"]),angular.module("phonegap.network",[]).factory("NetworkService",["$rootScope","$log","$interval","AppSettings",function(e,t,o,r){function n(){return navigator.network?navigator.network.connection.type!=Connection.NONE:!1}function i(){l=o(function(){var t=n();t!=c&&(e.$broadcast(r.OnNetworkStatusChange,t),c=t)},1e3)}function a(){o.cancel(l),l=void 0}var l,c=!1;return e.$on("$destroy",function(){l&&a()}),{networkReady:n,startMonitoring:i,stopMonitoring:a}}]),angular.module("phonegap.notification",[]).factory("NotificationService",["$rootScope",function(e){return{alert:function(t,o,r,n){navigator.notification.alert(t,function(){n&&"function"==typeof n&&e.$apply(function(){n()})},o,r)}}}]),angular.module("logtrip.gpstracker.controllers",["phonegap","settings","uiGmapgoogle-maps"]).controller("GPSTrackerController",["$scope","AppSettings","$log","uiGmapGoogleMapApi","GeolocationService",function(e,t,o,r,n){function i(e){return{coords:{latitude:e.coords.latitude,longitude:e.coords.longitude},options:{}}}function a(e){var t=0;if(e.length<=1)return 0;for(var o=0;o<e.length&&o!=e.length-1;o++)t+=l(e[o].coords.latitude,e[o].coords.longitude,e[o+1].coords.latitude,e[o+1].coords.longitude);var r=t.toFixed(2);return r}function l(e,t,o,r){var n=6371,i=(o-e)*(Math.PI/180),a=(r-t)*(Math.PI/180),e=e*(Math.PI/180),o=o*(Math.PI/180),l=Math.sin(i/2)*Math.sin(i/2)+Math.sin(a/2)*Math.sin(a/2)*Math.cos(e)*Math.cos(o),c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),u=n*c;return u}r.then(function(){n.getCurrentPosition(function(r){o.debug("setupMap"),e.map={tripInProgress:!1,center:{latitude:r.coords.latitude,longitude:r.coords.longitude},zoom:t.map_zoom},e.startMarker=i(r),o.debug(JSON.stringify(r))})}),e.startTrip=function(){o.debug("Starting trip"),n.getCurrentPosition(function(t){o.debug(JSON.stringify(t)),e.map.tripInProgress||(e.startMarker=i(t),e.map.tripInProgress=!0),n.watchPosition(function(t){e.lastMarker=i(t)})},function(e){o.debug(JSON.stringify(e))})},e.endTrip=function(){o.debug("Ending trip");var t=n.clearWatch();e.map.tripInProgress=!1,o.debug("total km:"+a(t))},e.simulateTracking=function(){$interval(function(){e.lastMarker.coords.latitude=e.lastMarker.coords.latitude+.01},3e3)}}]),angular.module("logtrip.gpstracker",["logtrip.gpstracker.controllers","uiGmapgoogle-maps"]).config(["uiGmapGoogleMapApiProvider",function(e){e.configure({key:"AIzaSyCaRr1NmrqzlJWuq1cFsr44hOQ0aOGlW4Q",v:"3.17"})}]),angular.module("logtrip.gpstracker.services",["phonegap","settings"]).factory("TrackingService",["GeolocationService","NotificationService",function(e){function t(){r=[];var t={frequency:3e3,enableHighAccuracy:!0};e.watchPosition(function(e){null==n&&(n=e),i=e,r.push(e),l=0},function(){l++,l>AppSettings.gps_error_threshold},t)}function o(){return a&&(e.clearWatch(a),a=null),r}var r=[],n=null,i=null,a=null,l=0;return{getCurrentPosition:e.getCurrentPosition,startTracking:t,stopTracking:o,startPosition:n,lastPosition:i}}]);var logManualControllers=angular.module("logtrip.manual.controllers",["SQLservices"]);logManualControllers.controller("LogManualController",["$q","$scope","$routeParams","$location","Trips","Vehicles","Drivers","NatureOfTrip",function(e,t,o,r,n,i,a,l){t.loadVehicles=function(){i.all().then(function(e){t.allvehicles=e})},t.loadDrivers=function(){a.all().then(function(e){t.alldrivers=e})},t.loadNatureOfTrips=function(){l.all().then(function(e){t.allnatureoftrips=e})},t.addTrip=function(e,o,i,a,l,c,u,s,d){n.add(e,o,i,a,l,c,u,s,d),r.url("/viewtrips"),t.loadVehicles(),t.loadDrivers(),t.loadNatureOfTrips()},t.loadVehicles(),t.loadDrivers(),t.loadNatureOfTrips()}]),angular.module("logtrip.manual",["logtrip.manual.controllers"]);var driverControllers=angular.module("driver.controllers",["SQLservices"]);driverControllers.controller("DriverController",["$q","$scope","Drivers",function(e,t,o){t.loadData=function(){o.all().then(function(e){t.entries=e})},t.addDriver=function(e,r,n){o.add(e,r,n),t.loadData()},t.removeDriver=function(e){o.remove(e),t.loadData()},t.loadData()}]),driverControllers.controller("EditDriverController",["$q","$scope","$routeParams","$location","Drivers",function(e,t,o,r,n){t.loadData=function(){var e=o.id;n.getById(e).then(function(e){t.entry=e,t.firstname=e.firstname,t.lastname=e.lastname,t.address=e.address})},t.updateDriver=function(e,t,o,i){n.update(e,t,o,i),r.url("/update/driver")},t.loadData()}]),angular.module("driver",["driver.controllers"]);var vehicleControllers=angular.module("vehicle.controllers",["SQLservices"]);vehicleControllers.controller("VehicleController",["$q","$scope","Vehicles",function(e,t,o){t.loadData=function(){o.all().then(function(e){t.entries=e})},t.addVehicle=function(e){o.add(e),t.loadData()},t.removeVehicle=function(e){o.remove(e),t.loadData()},t.loadData()}]),vehicleControllers.controller("EditVehicleController",["$q","$scope","$routeParams","$location","Vehicles",function(e,t,o,r,n){t.loadData=function(){var e=o.id;n.getById(e).then(function(e){t.entry=e,t.vehiclerego=e.vehiclerego})},t.updateVehicle=function(e,t){n.update(e,t),r.url("/update/vehicle")},t.loadData()}]),angular.module("vehicle",["vehicle.controllers"]);var edittripControllers=angular.module("edittrip.controllers",["SQLservices"]);edittripControllers.controller("EditTripController",["$q","$scope","$routeParams","$location","Trips","Vehicles","Drivers","NatureOfTrip",function(e,t,o,r,n,i,a,l){t.loadVehicles=function(){i.all().then(function(e){t.allvehicles=e})},t.loadDrivers=function(){a.all().then(function(e){t.alldrivers=e})},t.loadNatureOfTrips=function(){l.all().then(function(e){t.allnatureoftrips=e})},t.loadTrip=function(){var e=o.id;n.getById(e).then(function(e){t.entry=e,t.kmfrom=e.kmfrom,t.kmto=e.kmto,t.vehicleid=e.vehicleid,t.natureoftripid=e.natureoftripid,t.driverid=e.driverid,t.datestart=e.datestart,t.dateend=e.dateend,t.locationfrom=e.locationfrom,t.locationto=e.locationto})},t.updateTrip=function(e,t,o,i,a,l,c,u,s,d){n.update(e,t,o,i,a,l,c,u,s,d),r.url("/viewtrips")},t.loadVehicles(),t.loadDrivers(),t.loadNatureOfTrips(),t.loadTrip()}]),angular.module("edittrip",["edittrip.controllers"]);